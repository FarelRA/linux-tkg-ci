name: Build Arch

on:
  workflow_call:
    inputs:
      kernel_version:
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scheduler: [pds, bmq, bore, eevdf]
        config: [default, all-patches]
        arch: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Build in Arch container
        env:
          KERNEL_VERSION: ${{ inputs.kernel_version }}
          SCHEDULER: ${{ matrix.scheduler }}
          CONFIG: ${{ matrix.config }}
          BUILD_ARCH: ${{ matrix.arch }}
        run: |
          docker run --rm \
            -e KERNEL_VERSION -e SCHEDULER -e CONFIG -e BUILD_ARCH \
            -v "$PWD:/workspace" \
            -w /workspace \
            archlinux:latest \
            bash -c '
              set -ex
              pacman -Syu --noconfirm base-devel git bc cpio dwarves libelf perl python openssl
              
              if [ "$BUILD_ARCH" = "aarch64" ]; then
                pacman -S --noconfirm aarch64-linux-gnu-gcc
              fi
              
              useradd -m builder
              echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
              chown -R builder:builder /workspace
              su builder -c "bash scripts/build-arch.sh"
            '

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: arch-${{ matrix.arch }}-${{ matrix.scheduler }}-${{ matrix.config }}
          path: output/*.pkg.tar.zst
          retention-days: 1
          if-no-files-found: warn
